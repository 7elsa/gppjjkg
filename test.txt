# =============================================================================
# åˆæœŸè¨­å®š
# =============================================================================
try {
    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç½®ã‹ã‚Œã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åŸºæº–ã«å„ãƒ‘ã‚¹ã‚’è¨­å®š
    $scriptRoot = $PSScriptRoot
    $jqPath = Join-Path $scriptRoot -ChildPath "jq.exe"
    $inputDir = Join-Path $scriptRoot -ChildPath "input_file"
    $jqQueryDir = Join-Path $scriptRoot -ChildPath "jq_query"
    $outputDir = Join-Path $scriptRoot -ChildPath "output_files"

    # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    if (-not (Test-Path -Path $jqPath -PathType Leaf)) { throw "jq.exe ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $jqPath" }
    if (-not (Test-Path -Path $inputDir -PathType Container)) { throw "å…¥åŠ›ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $inputDir" }
    if (-not (Test-Path -Path $jqQueryDir -PathType Container)) { throw "JQã‚¯ã‚¨ãƒªãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $jqQueryDir" }

    # å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ãŒãªã‘ã‚Œã°ä½œæˆ
    if (-not (Test-Path -Path $outputDir -PathType Container)) {
        Write-Host "INFO: å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™: $outputDir"
        New-Item -Path $outputDir -ItemType Directory | Out-Null
    }

    # =============================================================================
    # ãƒ¡ã‚¤ãƒ³å‡¦ç†
    # =============================================================================

    # input_fileãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã®ã™ã¹ã¦ã®jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«å–å¾—
    $jsonFiles = Get-ChildItem -Path $inputDir -Filter "*.json" -Recurse

    if ($null -eq $jsonFiles) {
        Write-Warning "å‡¦ç†å¯¾è±¡ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
        exit
    }

    # BOMãªã—UTF-8ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨­å®š
    $utf8WithoutBom = New-Object System.Text.UTF8Encoding($false)

    # å„JSONãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦å‡¦ç†ã‚’å®Ÿè¡Œ
    foreach ($jsonFile in $jsonFiles) {
        
        Write-Host "--------------------------------------------------"
        Write-Host "â–¶ï¸ å‡¦ç†é–‹å§‹: $($jsonFile.FullName)"

        # ãƒ•ã‚¡ã‚¤ãƒ«åã®åŸºæœ¬éƒ¨åˆ†ï¼ˆæ‹¡å¼µå­ãªã—ï¼‰ã‚’å–å¾—
        $baseName = $jsonFile.BaseName
        
        # ---
        # 1. ã‚¤ãƒ³ãƒ—ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’BOMãªã—UTF-8ã«å¤‰æ›ã—ã¦ä¸Šæ›¸ã
        # ---
        try {
            $content = Get-Content -Path $jsonFile.FullName -Raw
            [System.IO.File]::WriteAllText($jsonFile.FullName, $content, $utf8WithoutBom)
            Write-Host "âœ… [1/2] BOMãªã—UTF-8ã¸å¤‰æ›å®Œäº†"
        }
        catch {
            Write-Warning "âš ï¸ [1/2] UTF-8å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $($_.Exception.Message)"
            continue # æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¸
        }

        # ---
        # 2. jq.exeã‚’ç”¨ã„ã¦CSVã«å¤‰æ›ã—ã€æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜
        # ---
        try {
            # å¯¾å¿œã™ã‚‹jqãƒ•ã‚¡ã‚¤ãƒ«ã¨å‡ºåŠ›å…ˆã®ãƒ‘ã‚¹ã‚’æ§‹ç¯‰
            $jqQueryFile = Join-Path -Path $jqQueryDir -ChildPath "$($baseName).jq"
            $outputSubDir = Join-Path -Path $outputDir -ChildPath $jsonFile.Directory.Name
            $csvOutputFile = Join-Path -Path $outputSubDir -ChildPath "$($baseName).csv"

            # å¯¾å¿œã™ã‚‹jqãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (-not (Test-Path -Path $jqQueryFile -PathType Leaf)) {
                Write-Warning "âš ï¸ [2/2] å¯¾å¿œã™ã‚‹JQãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™: $jqQueryFile"
                continue # æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¸
            }

            # å‡ºåŠ›å…ˆã®ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ãŒãªã‘ã‚Œã°ä½œæˆ
            if (-not (Test-Path -Path $outputSubDir -PathType Container)) {
                New-Item -Path $outputSubDir -ItemType Directory | Out-Null
            }

            # jqã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
            # -r ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç”Ÿã®æ–‡å­—åˆ—ã‚’å‡ºåŠ›ã—ã€CSVå½¢å¼ã«ã™ã‚‹
            & $jqPath -r -f $jqQueryFile $jsonFile.FullName | Set-Content -Path $csvOutputFile -Encoding utf8
            
            Write-Host "âœ… [2/2] CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ: $csvOutputFile"
        }
        catch {
            Write-Warning "âš ï¸ [2/2] JQå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $($_.Exception.Message)"
            continue # æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¸
        }
    }
    Write-Host "--------------------------------------------------"
    Write-Host "ğŸ‰ å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
}
catch {
    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
    Write-Error "âŒ è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $($_.Exception.Message)"
}
